<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatMed IPA MTs - Asisten Pembelajaran IPA</title>
    <meta name="description" content="Asisten virtual untuk pembelajaran IPA SMP/MTs dengan materi biologi, fisika, dan kimia">
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="">
    <style>
       /* ================== [1] BASE STYLES ================== */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background-color: #f5f7fa;
    color: #333;
    line-height: 1.6;
}

h1, h2, h3 {
    color: #2c3e50;
    margin-bottom: 1rem;
}

h1 {
    text-align: center;
    font-size: 1.8rem;
}

/* ================== [2] CHAT INTERFACE ================== */
#chatbox {
    height: 60vh;
    overflow-y: auto;
    padding: 15px;
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 15px;
    scroll-behavior: smooth;
}

.message {
    margin-bottom: 12px;
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 80%;
    word-wrap: break-word;
}

.user-message {
    background-color: #e3f2fd;
    margin-left: auto;
    border-bottom-right-radius: 5px;
}

.bot-message {
    background-color: #f1f1f1;
    margin-right: auto;
    border-bottom-left-radius: 5px;
}

/* ================== [3] INPUT AREA ================== */
.input-container {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

#userInput {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 25px;
    font-size: 16px;
    outline: none;
    transition: border 0.3s;
}

#userInput:focus {
    border-color: #4CAF50;
}

.button-group {
    display: flex;
    gap: 8px;
}

button {
    min-width: 40px;
    padding: 12px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

button:hover {
    background-color: #45a049;
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* ================== [4] SPECIAL MESSAGE STYLES ================== */
.answer-box {
    border-left: 3px solid #4CAF50;
    padding: 12px;
    margin: 10px 0;
    background-color: #f9f9f9;
    border-radius: 8px;
}

.topic-header {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.topic-badge, .subtopic-badge, .context-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
}

.topic-badge {
    background-color: #2c3e50;
    color: white;
}

.subtopic-badge {
    background-color: #3498db;
    color: white;
}

.context-badge {
    background-color: #f1c40f;
    color: #2c3e50;
}

.diagram-container {
    margin: 15px 0;
    text-align: center;
}

.diagram-container img {
    max-width: 100%;
    border-radius: 8px;
    border: 1px solid #eee;
}

.diagram-caption {
    font-size: 0.9rem;
    color: #7f8c8d;
    margin-top: 5px;
}

/* ================== [5] INTERACTION ELEMENTS ================== */
.typing-indicator {
    display: inline-block;
    padding: 10px 15px;
    background-color: #f1f1f1;
    border-radius: 18px;
    margin-bottom: 12px;
}

.typing-indicator span {
    height: 8px;
    width: 8px;
    background-color: #666;
    border-radius: 50%;
    display: inline-block;
    margin: 0 2px;
    animation: bounce 1.5s infinite ease-in-out;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

.follow-up {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px dashed #ddd;
}

.followup-title {
    font-size: 0.9rem;
    color: #7f8c8d;
    margin-bottom: 8px;
}

.followup-questions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.followup-btn {
    background-color: #e3f2fd !important;
    color: #2c3e50 !important;
    font-size: 0.85rem !important;
    padding: 8px 12px !important;
    min-width: unset !important;
}

.followup-btn:hover {
    background-color: #bbdefb !important;
}

/* ================== [6] UTILITY CLASSES ================== */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

.loading-spinner {
    display: none;
    animation: spin 1s linear infinite;
}

button[aria-busy="true"] .button-content {
    display: none;
}

button[aria-busy="true"] .loading-spinner {
    display: block;
}

.error-message {
    background-color: #ffebee !important;
    color: #c62828;
    padding: 12px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.not-found {
    display: flex;
    gap: 12px;
    align-items: center;
}

.not-found-icon {
    font-size: 1.5rem;
}

.not-found-text {
    flex: 1;
}

/* ================== [7] AUTO-SUGGESTIONS ================== */
#suggestions-container {
    position: absolute;
    width: calc(100% - 30px);
    max-width: 800px;
    background: white;
    border-radius: 0 0 10px 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    z-index: 100;
    margin-top: -15px;
}

.suggestion-item {
    padding: 10px 15px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.suggestion-item:hover {
    background-color: #f5f5f5;
}

/* ================== [8] ANIMATIONS ================== */
@keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-5px); }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ================== [9] RESPONSIVE DESIGN ================== */
@media (max-width: 600px) {
    body {
        padding: 10px;
    }
    
    #chatbox {
        height: 65vh;
    }
    
    .input-container {
        flex-direction: column;
    }
    
    #userInput {
        width: 100%;
        padding: 10px 12px;
    }
    
    .button-group {
        justify-content: flex-end;
    }
    
    button {
        width: 70px;
        padding: 10px;
    }
    
    .followup-questions {
        flex-direction: column;
    }
}
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-atom"></i> ChatMed IPA SMP/MTs</h1>
        <p class="subtitle">Asisten Virtual Pembelajaran IPA Kelas 7-9</p>
    </header>
    
    <main aria-live="polite" aria-atomic="false">
    <!-- Chat Messages Container -->
    <div id="chatbox" role="log" aria-live="polite"></div>
    
    <!-- Input Section -->
    <div class="input-container">
        <label for="userInput" class="sr-only">Masukkan pertanyaan IPA</label>
        <input type="text" 
               id="userInput" 
               placeholder="Tanyakan materi IPA..." 
               aria-label="Input pertanyaan IPA" 
               autocomplete="off"
               aria-controls="chatbox">
        
        <div class="button-group">
            <button type="button" 
                    id="sendButton" 
                    aria-label="Kirim pertanyaan"
                    aria-live="polite"
                    disabled>
                <span class="button-content">
                    <i class="fas fa-paper-plane" aria-hidden="true"></i>
                    <span>Kirim</span>
                </span>
                <span class="loading-spinner" aria-hidden="true">
                    <i class="fas fa-spinner fa-pulse"></i>
                </span>
            </button>
            
            <button type="button" 
                    id="clearChat" 
                    aria-label="Bersihkan percakapan"
                    aria-controls="chatbox">
                <i class="fas fa-trash-alt" aria-hidden="true"></i>
                <span class="sr-only">Bersihkan</span>
            </button>
        </div>
    </div>
    
    <!-- Quick Questions Section -->
    <section class="quick-questions" aria-labelledby="quickQuestionsHeading">
        <h2 id="quickQuestionsHeading" class="quick-questions-title">Coba tanyakan:</h2>
        <div class="quick-buttons" role="group" aria-labelledby="quickQuestionsHeading">
            <button type="button" 
                    class="quick-btn" 
                    data-question="Apa itu sel?"
                    aria-label="Ajukan pertanyaan: Apa itu sel?">
                Apa itu sel?
            </button>
            <button type="button" 
                    class="quick-btn" 
                    data-question="Bagaimana proses fotosintesis?"
                    aria-label="Ajukan pertanyaan: Bagaimana proses fotosintesis?">
                Proses fotosintesis
            </button>
            <button type="button" 
                    class="quick-btn" 
                    data-question="Sebutkan bagian sel hewan"
                    aria-label="Ajukan pertanyaan: Sebutkan bagian sel hewan">
                Bagian sel hewan
            </button>
        </div>
    </section>
</main>
    
    <footer>
        <p>&copy; 2025 Dibuat dengan <span class="heart">‚ù§Ô∏è</span> oleh Ahmad Zikrillah @Digital IPA Learning</p>
        <p class="version">Versi 2.1.0 | <span id="lastUpdated"></span></p>
    </footer>

    <!-- Script Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/indonesian-stemmer@0.0.3/dist/index.min.js"></script>   
    <script>
        // ================== [1] ENHANCED INITIALIZATION ================== //
const CONFIG = {
    DEBUG_MODE: true,
    TYPING_DELAY: 800,
    CACHE_TTL: 3600000, // 1 hour in ms
    MATCH_THRESHOLDS: {
        EXACT: 1.0,
        HIGH: 0.85,
        MEDIUM: 0.65,
        LOW: 0.45
    }
};

let dataset = {};
const responseCache = new Map();
const sessionContext = {
    lastTopic: null,
    lastSubtopic: null,
    followUpQuestions: [],
    lastResponseIndices: {},
    conversationHistory: []
};

// ================== [2] TEXT PROCESSING ENHANCEMENTS ================== //
const textProcessor = {
    normalize: (text) => {
        if (!text) return '';
        return text.toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/[^\w\s]/g, '')
            .replace(/\b(apa|bagaimana|mengapa|tolong|jelaskan|itu|sebutkan)\b/g, '')
            .replace(/\s+/g, ' ')
            .trim();
    },

    stem: (word) => {
        const specialStems = {
            "fotosintesis": "fotosintesis",
            "respirasi": "napas",
            "seluler": "sel",
            "mitokondria": "mitokondria",
            "voltage":"tegangan"
        };
        if (specialStems[word]) return specialStems[word];

        const suffixes = ['nya', 'lah', 'kah', 'adalah'];
        const prefixes = ['ber', 'ter', 'me'];
        
        let stemmed = word;
        for (const suffix of suffixes) {
            if (stemmed.endsWith(suffix)) {
                stemmed = stemmed.slice(0, -suffix.length);
                break;
            }
        }
        for (const prefix of prefixes) {
            if (stemmed.startsWith(prefix)) {
                stemmed = stemmed.slice(prefix.length);
                break;
            }
        }
        
        return stemmed.length > 2 ? stemmed : word;
    },

    tokenize: (text) => {
        return textProcessor.normalize(text).split(' ')
            .map(textProcessor.stem)
            .filter(word => word.length > 2);
    }
};

// ================== [3] SEMANTIC MATCHING ENGINE ================== //
const matcher = {
    findExactMatch: (query) => {
        const normalizedQuery = textProcessor.normalize(query);
        for (const [topic, topicData] of Object.entries(dataset.topics || {})) {
            for (const [subtopic, subtopicData] of Object.entries(topicData.subtopics || {})) {
                for (const qna of subtopicData.QnA || []) {
                    const exactMatch = qna.patterns.find(p => 
                        textProcessor.normalize(p) === normalizedQuery
                    );
                    if (exactMatch) {
                        return this._prepareMatchResult(topic, subtopic, qna);
                    }
                }
            }
        }
        return null;
    },

    findSemanticMatch: (query) => {
        let bestMatch = { confidence: 0 };
        const queryTokens = textProcessor.tokenize(query);

        for (const [topic, topicData] of Object.entries(dataset.topics || {})) {
            for (const [subtopic, subtopicData] of Object.entries(topicData.subtopics || {})) {
                for (const qna of subtopicData.QnA || []) {
                    const score = this._calculateMatchScore(query, queryTokens, topic, subtopic, qna);
                    if (score > bestMatch.confidence) {
                        bestMatch = this._prepareMatchResult(topic, subtopic, qna, score);
                    }
                }
            }
        }
        return bestMatch.confidence >= CONFIG.MATCH_THRESHOLDS.HIGH ? bestMatch : null;
    },

    _calculateMatchScore: (query, queryTokens, topic, subtopic, qna) => {
        // 1. Pattern matching
        const patternScore = Math.max(...qna.patterns.map(p => 
            this._jaccardSimilarity(queryTokens, textProcessor.tokenize(p))
        ));

        // 2. Intent matching
        const intentScore = qna.intent ? 
            this._jaccardSimilarity(queryTokens, textProcessor.tokenize(qna.intent)) : 0;

        // 3. Context bonus
        const contextBonus = sessionContext.lastTopic === topic ? 1.2 : 1.0;

        return (patternScore * 0.6 + intentScore * 0.3) * contextBonus;
    },

    _jaccardSimilarity: (tokensA, tokensB) => {
        const setA = new Set(tokensA);
        const setB = new Set(tokensB);
        const intersection = new Set([...setA].filter(t => setB.has(t)));
        const union = new Set([...setA, ...setB]);
        return union.size > 0 ? intersection.size / union.size : 0;
    },

    _prepareMatchResult: (topic, subtopic, qna, confidence = 1.0) => {
        const qnaKey = `${topic}|${subtopic}|${qna.intent}`;
        const lastIndex = sessionContext.lastResponseIndices[qnaKey] || 0;
        const responseIndex = (lastIndex + 1) % qna.responses.length;
        
        sessionContext.lastResponseIndices[qnaKey] = responseIndex;
        
        return {
            topic,
            subtopic,
            response: qna.responses[responseIndex],
            diagram: qna.diagram,
            intent: qna.intent,
            patterns: qna.patterns,
            confidence
        };
    }
};

// ================== [4] RESPONSE MANAGEMENT ================== //
const responseManager = {
    findAnswer: (query) => {
        const normalizedQuery = textProcessor.normalize(query);
        
        // Check cache
        if (responseCache.has(normalizedQuery)) {
            return responseCache.get(normalizedQuery);
        }

        // Try exact match first
        const exactMatch = matcher.findExactMatch(query);
        if (exactMatch) {
            return this._cacheAndFormatResponse(normalizedQuery, exactMatch);
        }

        // Fallback to semantic match
        const semanticMatch = matcher.findSemanticMatch(query);
        if (semanticMatch) {
            return this._cacheAndFormatResponse(normalizedQuery, semanticMatch);
        }

        // Final fallback
        return this._getFallbackResponse(query);
    },

    _cacheAndFormatResponse: (queryKey, match) => {
        const response = this._formatResponse(match);
        responseCache.set(queryKey, response);
        this._updateSessionContext(match, queryKey);
        return response;
    },

    _updateSessionContext: (match, query) => {
        sessionContext.lastTopic = match.topic;
        sessionContext.lastSubtopic = match.subtopic;
        sessionContext.conversationHistory.push({
            query,
            topic: match.topic,
            subtopic: match.subtopic,
            timestamp: new Date()
        });

        // Generate follow-up questions
        sessionContext.followUpQuestions = match.patterns
            .filter(p => {
                const patternNorm = textProcessor.normalize(p);
                return patternNorm !== query && 
                       matcher._jaccardSimilarity(
                           textProcessor.tokenize(query), 
                           textProcessor.tokenize(patternNorm)
                       ) < 0.7;
            })
            .slice(0, 3);
    },

    _formatResponse: (match) => {
        let response = `
            <div class="answer-box">
                <div class="topic-header">
                    <span class="topic-badge">${match.topic}</span>
                    <span class="subtopic-badge">${match.subtopic}</span>
                    ${sessionContext.lastTopic === match.topic ? 
                       '<span class="context-badge">üëà Topik Sebelumnya</span>' : ''}
                </div>
                <div class="answer-content">${match.response}</div>
        `;
        
        if (match.diagram) {
            response += `
                <div class="diagram-container">
                    <img src="${match.diagram}" alt="${match.subtopic}" 
                         loading="lazy" onerror="this.style.display='none'">
                    <div class="diagram-caption">Diagram ${match.subtopic}</div>
                </div>
            `;
        }
        
        if (sessionContext.followUpQuestions.length > 0) {
            response += `
                <div class="follow-up">
                    <div class="followup-title">Mungkin Kamu ingin tanya:</div>
                    <div class="followup-questions">
                        ${sessionContext.followUpQuestions.map(q => `
                            <button class="followup-btn" 
                                    onclick="setQueryAndSend('${q.replace(/'/g, "\\'")}')">
                                ${q}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        if (CONFIG.DEBUG_MODE) {
            response += `<div class="debug-info">Confidence: ${Math.round(match.confidence * 100)}%</div>`;
        }
        
        return response + `</div>`;
    },

    _getFallbackResponse: (query) => {
        const keywords = textProcessor.tokenize(query);
        const suggestions = [
            "Coba tanyakan tentang:",
            "- Struktur sel hewan dan tumbuhan",
            "- Proses fotosintesis",
            "- Hukum Newton",
            "- Reaksi kimia sederhana"
        ].join("<br>");
        
        return `
            <div class="not-found">
                <div class="not-found-icon">‚ùì</div>
                <div class="not-found-text">
                    <p>Saya belum memahami pertanyaan Anda.</p>
                    <p>${suggestions}</p>
                </div>
            </div>
        `;
    }
};

// ================== [5] UI CONTROLLER ================== //
const uiController = {
    init: () => {
        this._setupEventListeners();
        this._loadDataset();
        this._setupAutoSuggestion();
    },

    _setupEventListeners: () => {
        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.sendMessage();
        });

        document.getElementById('sendButton').addEventListener('click', () => this.sendMessage());

        document.getElementById('clearChat').addEventListener('click', () => {
            if (confirm('Hapus seluruh percakapan?')) {
                document.getElementById('chatbox').innerHTML = '';
                sessionContext.lastTopic = null;
                sessionContext.lastSubtopic = null;
                sessionContext.followUpQuestions = [];
                this.addMessage("Halo! Ada yang bisa saya bantu?");
            }
        });
    },

    _loadDataset: () => {
        fetch('dataseek.json')
            .then(response => {
                if (!response.ok) throw new Error('Gagal memuat dataset');
                return response.json();
            })
            .then(data => {
                dataset = data.ipa_smp || {};
                this.addMessage("Halo! Saya asisten Pak Zikri. Kamu bisa bertanya tentang:");
                this.addMessage(`
                    <div class="welcome-message">
                        <div><b>Biologi</b>: Sel, Fotosintesis, Sistem Organ</div>
                        <div><b>Fisika</b>: Gaya, Energi, Listrik</div>
                        <div><b>Kimia</b>: Asam-Basa, Reaksi Kimia</div>
                    </div>
                `);
            })
            .catch(error => {
                console.error("Error:", error);
                this.addMessage(`
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        Sistem sedang dalam pemeliharaan. Silakan coba lagi nanti.
                    </div>
                `);
            });
    },

    _setupAutoSuggestion: () => {
        const input = document.getElementById('userInput');
        const container = document.createElement('div');
        container.id = 'suggestions-container';
        input.parentNode.insertBefore(container, input.nextSibling);

        input.addEventListener('input', () => {
            clearTimeout(this.suggestionTimeout);
            this.suggestionTimeout = setTimeout(() => {
                const query = input.value.trim();
                if (query.length > 1) {
                    this._showSuggestions(query, container);
                } else {
                    container.innerHTML = '';
                }
            }, 300);
        });

        document.addEventListener('click', (e) => {
            if (!input.contains(e.target) {
                container.innerHTML = '';
            }
        });
    },

    _showSuggestions: (query, container) => {
        const normalizedQuery = textProcessor.normalize(query);
        const suggestions = new Set();

        for (const topic of Object.values(dataset.topics || {})) {
            for (const subtopic of Object.values(topic.subtopics || {})) {
                for (const qna of subtopic.QnA || []) {
                    for (const pattern of qna.patterns || []) {
                        if (textProcessor.normalize(pattern).includes(normalizedQuery)) {
                            suggestions.add(pattern);
                            if (suggestions.size >= 5) break;
                        }
                    }
                }
            }
        }

        container.innerHTML = suggestions.size > 0 
            ? Array.from(suggestions).map(s => `
                <div class="suggestion-item" onclick="setQuery('${s.replace(/'/g, "\\'")}')">
                    ${s}
                </div>
              `).join('')
            : '';
    },

    addMessage: (content, isBot = true) => {
        const chatbox = document.getElementById('chatbox');
        
        if (isBot) {
            chatbox.innerHTML += `
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>`;
        }

        setTimeout(() => {
            if (isBot) {
                const typing = document.querySelector('.typing-indicator');
                if (typing) typing.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isBot ? 'bot-message' : 'user-message'}`;
            messageDiv.innerHTML = content;
            chatbox.appendChild(messageDiv);
            chatbox.scrollTop = chatbox.scrollHeight;
        }, isBot ? CONFIG.TYPING_DELAY : 0);
    },

    sendMessage: () => {
        const input = document.getElementById('userInput');
        const message = input.value.trim();
        if (!message) return;

        this.addMessage(message, false);
        input.value = '';
        document.getElementById('suggestions-container').innerHTML = '';

        setTimeout(() => {
            try {
                const answer = responseManager.findAnswer(message);
                this.addMessage(answer);
            } catch (error) {
                console.error("Error:", error);
                this.addMessage(`
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        Terjadi kesalahan saat memproses pertanyaan.
                    </div>
                `);
            }
        }, CONFIG.TYPING_DELAY);
    }
};

// ================== [6] INITIALIZATION ================== //
document.addEventListener('DOMContentLoaded', () => uiController.init());

// ================== [7] GLOBAL HELPERS ================== //
window.setQuery = (text) => {
    const input = document.getElementById('userInput');
    input.value = text;
    input.focus();
    document.getElementById('suggestions-container').innerHTML = '';
};

window.setQueryAndSend = (text) => {
    setQuery(text);
    uiController.sendMessage();
};

window.debug = {
    getContext: () => sessionContext,
    clearCache: () => responseCache.clear(),
    findAnswer: (query) => responseManager.findAnswer(query)
};
    </script>
</body>
</html>
