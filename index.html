<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ChatMed IPA MTs/SMP</title>
  <meta name="description" content="Asisten virtual untuk pembelajaran IPA SMP/MTs dengan materi biologi, fisika, dan kimia" />
  <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.8rem;
    }

    .subtitle {
      text-align: center;
      font-size: 1rem;
      margin-bottom: 20px;
      color: #555;
    }

    #chatbox {
      height: 60vh;
      overflow-y: auto;
      padding: 15px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 15px;
      scroll-behavior: smooth;
    }

    .message {
      margin-bottom: 12px;
      padding: 12px 18px;
      border-radius: 18px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .user-message {
      background-color: #e3f2fd;
      margin-left: auto;
      border-bottom-right-radius: 5px;
      color: #333;
    }

    .bot-message {
      background-color: #f1f1f1;
      margin-right: auto;
      border-bottom-left-radius: 5px;
      color: #333;
    }

    .input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    #userInput {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 25px;
      font-size: 16px;
      outline: none;
    }

    #userInput:focus {
      border-color: #4caf50;
    }

    button {
      padding: 10px 16px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }
  
    .suggestion-box {
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 10px;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
      width: 100%;
    }

    .suggestion-box p {
      margin: 5px 0;
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
    }

    .suggestion-box p:hover {
      background-color: #e0e0e0;
    }

    .typing-indicator {
      display: inline-block;
      padding: 10px 15px;
      background-color: #f1f1f1;
      border-radius: 18px;
      margin-bottom: 12px;
    }

    .typing-indicator span {
      height: 8px;
      width: 8px;
      background-color: #666;
      border-radius: 50%;
      display: inline-block;
      margin: 0 2px;
      animation: bounce 1.5s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }

    footer {
      text-align: center;
      margin-top: 20px;
      color: #7f8c8d;
      font-size: 0.9rem;
    }

    .heart {
      color: #e74c3c;
    }

    .hidden {
      display: none;
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      #chatbox {
        height: 55vh;
        padding: 10px;
      }

      .input-container {
        flex-direction: column;
        align-items: stretch;
      }

      #userInput {
        width: 100%;
      }

      button {
        width: 100%;
      }
    
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-atom"></i> ChatMed IPA SMP/MTs</h1>
    <p class="subtitle">Asisten Virtual AI Pembelajaran IPA</p>
  </header>

  <main>
    <div id="chatbox"></div>

    <div class="input-container">
      <input type="text" id="userInput" placeholder="Ketik Pertanyaan tentang IPA..." aria-label="Input pertanyaan IPA" autocomplete="off" />
      <button id="sendButton" aria-label="Tanya Pak ZIKRI"><i class="fas fa-paper-plane"></i> Kirim</button>
      <button id="clearChat" aria-label="Bersihkan percakapan"><i class="fas fa-trash-alt"></i></button>
      <div id="suggestion-box" class="suggestion-box hidden"></div>
    </div>
    
  </main>

  <footer>
    <p>&copy; 2025 Dibuat dengan <span class="heart">❤️</span> oleh Ahmad Zikrillah @Digital IPA Learning</p>
    <p class="version">Versi 2.1.0 | <span id="lastUpdated"></span></p>
  </footer>
  <!-- Script Eksternal -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/indonesian-stemmer@0.0.3/dist/index.min.js"></script>    
    <!-- Main Script -->
<script>
  // ================ [1] INITIALIZATION ================ //
const dataset = {
    topics: {
        "Biologi": {
            subtopics: {
                "Sel": {
                    QnA: [{
                        patterns: ["apa itu sel", "definisi sel", "jelaskan tentang sel"],
                        responses: [
                            "Sel adalah unit terkecil penyusun makhluk hidup. Terdiri dari membran sel, sitoplasma, dan inti sel.",
                            "Dalam biologi, sel merupakan struktur dasar semua makhluk hidup. Setiap organisme terdiri dari satu atau lebih sel."
                        ],
                        diagram: "images/sel.png"
                    }]
                },
                "Fotosintesis": {
                    QnA: [{
                        patterns: ["proses fotosintesis", "bagaimana fotosintesis bekerja"],
                        responses: [
                            "Fotosintesis adalah proses tumbuhan mengubah cahaya matahari menjadi energi kimia.",
                            "Proses fotosintesis terjadi di kloroplas dengan rumus: 6CO₂ + 6H₂O + cahaya → C₆H₁₂O₆ + 6O₂"
                        ],
                        diagram: "images/fotosintesis.png"
                    }]
                }
            }
        },
        "Fisika": {
            subtopics: {
                "Gaya": {
                    QnA: [{
                        patterns: ["apa itu gaya", "jenis-jenis gaya", "contoh gaya dalam fisika"],
                        responses: [
                            "Gaya adalah interaksi yang dapat menyebabkan benda bergerak atau berubah bentuk. Contoh: gaya gravitasi, gaya gesek.",
                            "Dalam fisika, gaya diukur dalam newton (N). Jenis utama: gaya kontak dan gaya lapangan."
                        ],
                        diagram: "images/gaya.png"
                    }]
                }
            }
        }
    }
};

let sessionContext = {
    currentTopic: null,
    lastSubtopic: null,
    conversationHistory: []
};

// ================ [2] TEXT PROCESSING ================ //
function normalizeText(text) {
    if (!text) return '';
    return text.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^\w\s]/g, '')
        .replace(/\b(apa|bagaimana|mengapa|tolong|jelaskan|sebutkan)\b/g, '')
        .replace(/\s+/g, ' ')
        .trim();
}

function tokenize(text) {
    return normalizeText(text).split(' ').filter(word => word.length > 2);
}

// ================ [3] ENHANCED MATCHING ENGINE ================ //
function calculateMatchScore(query, pattern) {
    const queryTokens = new Set(tokenize(query));
    const patternTokens = new Set(tokenize(pattern));
    
    // 1. Base similarity
    const intersection = new Set([...queryTokens].filter(t => patternTokens.has(t)));
    const union = new Set([...queryTokens, ...patternTokens]);
    let score = intersection.size / union.size;
    
    // 2. Context bonus
    if (sessionContext.currentTopic && pattern.includes(sessionContext.currentTopic)) {
        score *= 1.3;
    }
    
    // 3. Question type bonus
    const questionTypes = {
        'apa': 1.2, 
        'bagaimana': 1.15,
        'mengapa': 1.1
    };
    for (const [type, bonus] of Object.entries(questionTypes)) {
        if (query.includes(type) && pattern.includes(type)) {
            score *= bonus;
            break;
        }
    }
    
    return Math.min(score, 1.0);
}

function findBestMatch(query) {
    const normalizedQuery = normalizeText(query);
    let bestMatch = { score: 0 };

    // Priority 1: Check current topic first
    if (sessionContext.currentTopic) {
        const topicData = dataset.topics[sessionContext.currentTopic];
        for (const [subtopic, subtopicData] of Object.entries(topicData.subtopics)) {
            for (const qna of subtopicData.QnA) {
                for (const pattern of qna.patterns) {
                    const score = calculateMatchScore(normalizedQuery, pattern);
                    if (score > bestMatch.score) {
                        bestMatch = {
                            score,
                            topic: sessionContext.currentTopic,
                            subtopic,
                            response: qna.responses[Math.floor(Math.random() * qna.responses.length)],
                            diagram: qna.diagram
                        };
                    }
                }
            }
        }
        
        if (bestMatch.score > 0.7) {
            return bestMatch;
        }
    }

    // Priority 2: Global search
    for (const [topic, topicData] of Object.entries(dataset.topics)) {
        for (const [subtopic, subtopicData] of Object.entries(topicData.subtopics)) {
            for (const qna of subtopicData.QnA) {
                for (const pattern of qna.patterns) {
                    const score = calculateMatchScore(normalizedQuery, pattern);
                    if (score > bestMatch.score) {
                        bestMatch = {
                            score,
                            topic,
                            subtopic,
                            response: qna.responses[Math.floor(Math.random() * qna.responses.length)],
                            diagram: qna.diagram
                        };
                    }
                }
            }
        }
    }

    return bestMatch.score > 0.6 ? bestMatch : null;
}

// ================ [4] RESPONSE MANAGEMENT ================ //
function formatResponse(match) {
    let html = `
        <div class="answer-box">
            <div class="topic-header">
                <span class="topic">${match.topic}</span>
                <span class="subtopic">${match.subtopic}</span>
                ${sessionContext.currentTopic === match.topic ? 
                 '<span class="context-badge">(Topik Terkait)</span>' : ''}
            </div>
            <div class="answer-content">${match.response}</div>
    `;
    
    if (match.diagram) {
        html += `
            <div class="diagram">
                <img src="${match.diagram}" alt="${match.subtopic}" 
                     onerror="this.style.display='none'">
            </div>
        `;
    }
    
    html += `</div>`;
    return html;
}

function getFallbackResponse() {
    if (sessionContext.currentTopic) {
        const subtopics = Object.keys(dataset.topics[sessionContext.currentTopic].subtopics);
        return `
            <div class="not-found">
                <p>Dalam topik <strong>${sessionContext.currentTopic}</strong>, 
                coba tanyakan tentang:</p>
                <ul>
                    ${subtopics.map(st => `<li>${st}</li>`).join('')}
                </ul>
            </div>
        `;
    }
    
    const topics = Object.keys(dataset.topics);
    return `
        <div class="not-found">
            <p>Coba tanyakan salah satu topik berikut:</p>
            <ul>
                ${topics.map(t => `<li>${t}</li>`).join('')}
            </ul>
        </div>
    `;
}

// ================ [5] CHAT INTERFACE ================ //
function addMessage(content, isBot = true) {
    const chatbox = document.getElementById('chatbox');
    const messageDiv = document.createElement('div');
    
    messageDiv.className = `message ${isBot ? 'bot-message' : 'user-message'}`;
    messageDiv.innerHTML = content;
    chatbox.appendChild(messageDiv);
    
    // Scroll to bottom
    chatbox.scrollTop = chatbox.scrollHeight;
}

function processUserInput() {
    const input = document.getElementById('userInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message
    addMessage(message, false);
    input.value = '';
    
    // Process and show response
    setTimeout(() => {
        try {
            const match = findBestMatch(message);
            
            if (match) {
                sessionContext.currentTopic = match.topic;
                sessionContext.lastSubtopic = match.subtopic;
                sessionContext.conversationHistory.push({
                    query: message,
                    response: match.response,
                    timestamp: new Date()
                });
                
                addMessage(formatResponse(match));
            } else {
                addMessage(getFallbackResponse());
            }
        } catch (error) {
            console.error("Error:", error);
            addMessage(`
                <div class="error-message">
                    Terjadi kesalahan sistem. Silakan coba lagi.
                </div>
            `);
        }
    }, 500);
}

// ================ [6] EVENT HANDLERS ================ //
function setupEventListeners() {
    document.getElementById('sendButton').addEventListener('click', processUserInput);
    
    document.getElementById('userInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') processUserInput();
    });
    
    document.getElementById('clearChat').addEventListener('click', () => {
        document.getElementById('chatbox').innerHTML = '';
        sessionContext = {
            currentTopic: null,
            lastSubtopic: null,
            conversationHistory: []
        };
        showWelcomeMessage();
    });
}

function showWelcomeMessage() {
    addMessage("Halo! Saya Asisten IPA. Silakan ajukan pertanyaan Anda.");
    addMessage(`
        <div class="welcome-message">
            <p><b>Contoh pertanyaan:</b></p>
            <ul>
                <li>Apa itu sel?</li>
                <li>Bagaimana proses fotosintesis?</li>
                <li>Jelaskan jenis-jenis gaya</li>
            </ul>
        </div>
    `);
}

// ================ [7] INITIALIZATION ================ //
document.addEventListener('DOMContentLoaded', () => {
    setupEventListeners();
    showWelcomeMessage();
});
</script>
</body>
</html>
